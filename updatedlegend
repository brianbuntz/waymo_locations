<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Waymo Deployment Timeline</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #121212; color: white; }
        #map { width: 100vw; height: 100vh; z-index: 1; }
        /* Glassmorphism Base */
        .glass-panel {
            background: rgba(20, 20, 20, 0.75);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            padding: 12px;
            border-radius: 10px;
            box-shadow: 0 6px 30px rgba(0,0,0,0.6);
        }
        .overlay-container { position: absolute; top: 20px; left: 20px; right: 20px; pointer-events: none; }
        .top-bar { display:flex; gap: 12px; align-items: center; }
        .title-box { flex: 1; }
        .title-text { margin: 0; font-size: 18px; }
        .subtitle-text { margin: 0; font-size: 12px; color: #bbb; }
        .stats-box { width: 180px; text-align: center; }
        .stat-number { font-size: 22px; margin: 0; }
        .stat-label { margin: 0; font-size: 11px; color: #aaa; }
        .timeline-container { position: absolute; left: 20px; top: 120px; width: 320px; pointer-events: auto; }
        .play-btn { background: rgba(255,255,255,0.06); border: none; width: 48px; height: 48px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .play-btn:hover { transform: scale(1.05); }
        .slider-label { font-size: 14px; color: #ccc; margin-bottom: 10px; display: block; text-transform: uppercase; letter-spacing: 1px; }
        .year-display { font-size: 42px; font-weight: 800; color: #fff; text-shadow: 0 2px 10px rgba(0,0,0,0.5); margin: 5px 0 15px 0; display: block; }
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%; background: #ffffff; cursor: pointer; margin-top: -10px; box-shadow: 0 0 10px rgba(255,255,255,0.5); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #444; border-radius: 2px; }
        /* Legend */
        .legend-box { position: absolute; bottom: 30px; right: 30px; width: 260px; pointer-events: auto; }
        .legend-item { display: flex; align-items: center; margin-bottom: 8px; font-size: 13px; }
        .dot { width: 12px; height: 12px; border-radius: 50%; margin-right: 10px; }
        /* Popup Styling */
        .leaflet-popup-content-wrapper { background-color: #1e1e1e; color: #fff; border: 1px solid #444; border-radius: 8px; }
        .leaflet-popup-tip { background-color: #1e1e1e; }
        .popup-header { font-size: 16px; font-weight: bold; margin-bottom: 5px; border-bottom: 1px solid #444; padding-bottom: 5px; }
        .popup-meta { font-size: 12px; color: #aaa; margin-bottom: 5px; }
        .popup-tag { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; text-transform: uppercase; margin-bottom: 5px; }
        .popup-service-area { background: rgba(0, 230, 118, 0.15); border: 1px solid rgba(0, 230, 118, 0.3); border-radius: 4px; padding: 4px 8px; margin-top: 8px; font-size: 12px; }
        .popup-service-area strong { color: #00e676; }
    </style>
</head>
<body>

    <div id="map"></div>

    <div class="overlay-container">
        <div class="top-bar">
            <div class="glass-panel title-box">
                <h1 class="title-text">Waymo Deployment</h1>
                <p class="subtitle-text">Interactive Timeline of Operations</p>
            </div>
            <div class="glass-panel stats-box">
                <p class="stat-number" id="cityCount">5</p>
                <p class="stat-label">Cities with Public Service</p>
            </div>
        </div>

        <div class="glass-panel timeline-container">
            <button id="playBtn" class="play-btn">
                <svg width="14" height="18" viewBox="0 0 14 18" fill="none" xmlns="http://www.w3.org/2000/svg" id="playIcon">
                    <path d="M1 1L13 9L1 17V1Z" stroke="white" stroke-width="2" stroke-linejoin="round"/>
                </svg>
                <svg width="14" height="18" viewBox="0 0 14 18" fill="none" xmlns="http://www.w3.org/2000/svg" id="pauseIcon" style="display:none;">
                    <path d="M1 1H5V17H1V1Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M9 1H13V17H9V1Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
            <div class="timeline-controls" style="display:inline-block; width:240px; margin-left:12px; vertical-align: top;">
                <span class="slider-label">Commercial Service Timeline</span>
                <span id="yearDisplay" class="year-display">2025</span>
                <input type="range" id="yearSlider" min="2020" max="2028" value="2025" step="1">
                <div style="display: flex; justify-content: space-between; color: #666; font-size: 12px; margin-top: 5px;">
                    <span>2020</span>
                    <span>2028+</span>
                </div>
            </div>
        </div>
    </div>

    <div class="glass-panel legend-box">
        <div style="font-weight: 600; margin-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 5px;">
            Status Legend
        </div>

        <!-- Live / Public -->
        <div class="legend-item">
            <span class="dot" style="background:#00e676; box-shadow: 0 0 6px #00e676;"></span>
            <div>
                <div style="font-weight:600;">Live / Public Service</div>
                <div style="font-size:11px; color:#bbb;">Publicly available, passenger service</div>
            </div>
        </div>

        <!-- Testing - Employee / Safety / Autonomous / Winter -->
        <div class="legend-item">
            <span class="dot" style="background:#ffab00;"></span>
            <div>
                <div style="font-weight:600;">Testing - Employee / Safety / Autonomous</div>
                <div style="font-size:11px; color:#bbb;">Limited operations (employees, safety drivers, or internal/autonomous testing)</div>
            </div>
        </div>

        <!-- Testing / Mapping / Data Collection -->
        <div class="legend-item">
            <span class="dot" style="background:#2979ff;"></span>
            <div>
                <div style="font-weight:600;">Testing / Mapping / Data Collection</div>
                <div style="font-size:11px; color:#bbb;">Mapping and data-collection activity (non-public)</div>
            </div>
        </div>

        <!-- Planned / Future (translucent) -->
        <div class="legend-item">
            <span class="dot" style="background:#aaa; opacity:0.5; border: 1px solid rgba(255,255,255,0.08);"></span>
            <div>
                <div style="font-weight:600;">Planned / Future</div>
                <div style="font-size:11px; color:#bbb;">Planned or pre-launch locations (shown translucently on the timeline)</div>
            </div>
        </div>

        <!-- Future / Pre-launch visual hint -->
        <div class="legend-item">
            <span class="dot" style="background: linear-gradient(0deg, rgba(255,255,255,0.15), rgba(255,255,255,0.15)); width:14px; height:14px; border-radius:50%; margin-right:10px; box-shadow: none;"></span>
            <div>
                <div style="font-weight:600;">Future / Pre-launch (faded)</div>
                <div style="font-size:11px; color:#bbb;">Markers with reduced opacity represent locations before public launch</div>
            </div>
        </div>

        <div style="margin-top: 10px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.1); font-size: 11px; color: #888;">
            <em>Dot size = service area coverage</em>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script>
        // Data with year-by-year service area information
        const waymoData = [
            // === LIVE PUBLIC SERVICE ===
            { 
                city: "Phoenix", state: "AZ", country: "USA",
                status: "Live - Public", 
                operationsStarted: 2020, publicYear: 2020, 
                lat: 33.4483771, lng: -112.0740373, 
                baseNotes: "Public operations since 2020.",
                serviceAreaByYear: {2020: '120 sq mi', 2021: '150 sq mi', 2022: '180 sq mi'}
            },
            { 
                city: "San Francisco", state: "CA", country: "USA",
                status: "Live - Public", 
                operationsStarted: 2021, publicYear: 2021, 
                lat: 37.7749, lng: -122.4194, 
                baseNotes: "Expanded to new neighborhoods in 2022.",
                serviceAreaByYear: {2021: '60 sq mi', 2022: '90 sq mi'}
            },

            // === TESTING / MAPPING - EXAMPLES ===
            { 
                city: "Pittsburgh", state: "PA", country: "USA",
                status: "Testing - Mapping", 
                operationsStarted: 2025, publicYear: 2027, 
                lat: 40.4406, lng: -79.9959, 
                baseNotes: "Mapping and manually driven test vehicles."
            },
            { 
                city: "St. Louis", state: "MO", country: "USA",
                status: "Testing - Mapping", 
                operationsStarted: 2025, publicYear: 2027, 
                lat: 38.627, lng: -90.1994, 
                baseNotes: "Data collection with human drivers."
            },

            // === TESTING ONLY - FAR FUTURE ===
            { 
                city: "Buffalo", state: "NY", country: "USA",
                status: "Testing - Winter/Snow", 
                operationsStarted: 2024, publicYear: 2028, 
                lat: 42.8864468, lng: -78.8783689, 
                baseNotes: "Winter weather capability testing."
            }
        ];

        // Map Initialization
        const map = L.map('map', {
            zoomControl: false,
            attributionControl: false
        }).setView([36.0, -96], 4);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 20
        }).addTo(map);
        
        L.control.attribution({position: 'bottomleft'}).addTo(map);

        let markersLayer = L.layerGroup().addTo(map);

        // Helper: Get Color based on Status
        function getColor(status) {
            if (!status) return '#2979ff';
            if (status.includes('Live')) return '#00e676';
            if (status.includes('Testing') && (status.includes('Employee') || status.includes('Autonomous') || status.includes('Safety') || status.includes('Winter'))) return '#ffab00';
            if (status.includes('Testing') || status.includes('Mapping')) return '#2979ff';
            return '#2979ff'; // Planned / default
        }

        // Helper: Get service area for a specific year
        function getServiceAreaForYear(loc, year) {
            if (!loc.serviceAreaByYear) return null;
            // Find the most recent service area data at or before this year
            let relevantYear = null;
            for (let y = year; y >= 2020; y--) {
                if (loc.serviceAreaByYear[y]) {
                    relevantYear = y;
                    break;
                }
            }
            return relevantYear ? loc.serviceAreaByYear[relevantYear] : null;
        }

        // Update Map function
        function updateMap(year) {
            markersLayer.clearLayers();
            let publicCityCount = 0;

            waymoData.forEach(loc => {
                // Determine visibility: show if operations have started or public service year reached
                const showOnMap = (loc.operationsStarted <= year) || (loc.publicYear <= year);
                if (!showOnMap) return;

                const isPublic = loc.publicYear <= year && loc.status.includes('Live');
                const isFuture = loc.publicYear > year;
                const isNew = loc.publicYear === year && !isFuture;
                if (isPublic) publicCityCount++;

                const color = getColor(loc.status);

                // Determine current status based on timeline
                let displayStatus = loc.status;
                if (isFuture && loc.status.includes('Live')) {
                    // Before public launch, show as testing
                    if (loc.status.includes('Partnership')) {
                        displayStatus = 'Pre-Launch Testing';
                    } else {
                        displayStatus = 'Testing - Pre-Launch';
                    }
                }

                // Get service area for this year
                const serviceArea = getServiceAreaForYear(loc, year);

                // Calculate radius based on service area (if available and public)
                let radius = 6; // Default for testing/mapping locations
                if (serviceArea && loc.publicYear <= year) {
                    // Extract numeric value from service area string (e.g., "315 sq mi" -> 315)
                    const areaValue = parseInt(serviceArea.replace(/[^0-9]/g, '')) || 0;
                    // Scale: sqrt for area-to-radius, then normalize (min 8, max 28)
                    radius = Math.max(8, Math.min(28, 4 + Math.sqrt(areaValue) * 1.4));
                }
                if (isNew) radius = Math.max(radius, 12); // Ensure new launches are visible

                const marker = L.circleMarker([loc.lat, loc.lng], {
                    radius: radius,
                    fillColor: color,
                    color: "#fff",
                    weight: isFuture ? 0 : 1,
                    opacity: isFuture ? 0 : 1,
                    fillOpacity: isFuture ? 0.35 : 0.85
                });

                let notes = loc.baseNotes || '';
                if (serviceArea) {
                    notes += `\nService area (${year || loc.publicYear}): ${serviceArea}`;
                }

                const popupHtml = `<div class=\"popup\"><div class=\"popup-header\">${loc.city}${loc.state ? ', ' + loc.state : ''}${loc.country ? ' - ' + loc.country : ''}</div><div class=\"popup-meta\">Status: ${displayStatus}</div><div class=\"popup-service-area\"><strong>${serviceArea || 'N/A'}</strong></div><div style=\"margin-top:8px; white-space:pre-wrap; font-size:13px; color:#ddd\">${notes}</div></div>`;

                marker.bindPopup(popupHtml);
                marker.addTo(markersLayer);
            });

            document.getElementById('cityCount').innerText = publicCityCount;
        }

        let isPlaying = false;
        const slider = document.getElementById('yearSlider');
        const display = document.getElementById('yearDisplay');
        const playBtn = document.getElementById('playBtn');
        const playIcon = document.getElementById('playIcon');
        const pauseIcon = document.getElementById('pauseIcon');

        let intervalId = null;

        function togglePlay() {
            isPlaying = !isPlaying;
            if (isPlaying) {
                playIcon.style.display = 'none';
                pauseIcon.style.display = 'block';
                if (parseInt(slider.value) >= parseInt(slider.max)) {
                    slider.value = slider.min;
                    updateDisplayAndMap(slider.min);
                }
                intervalId = setInterval(() => {
                    let currentVal = parseInt(slider.value);
                    if (currentVal < parseInt(slider.max)) {
                        currentVal++;
                        slider.value = currentVal;
                        updateDisplayAndMap(currentVal);
                    } else {
                        togglePlay();
                    }
                }, 1000);
            } else {
                playIcon.style.display = 'block';
                pauseIcon.style.display = 'none';
                clearInterval(intervalId);
            }
        }

        function updateDisplayAndMap(val) {
            display.innerText = val;
            updateMap(parseInt(val));
        }

        slider.addEventListener('input', (e) => {
            updateDisplayAndMap(e.target.value);
        });

        playBtn.addEventListener('click', togglePlay);

        // Initial Load
        updateDisplayAndMap(2020);

    </script>
</body>
</html>
