<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Waymo Deployment Timeline</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #121212; color: white; }
        #map { width: 100vw; height: 100vh; z-index: 1; }
        
        /* Glassmorphism Base */
        .glass-panel {
            background: rgba(20, 20, 20, 0.75);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            border-radius: 12px;
            padding: 15px;
            pointer-events: auto;
        }

        /* Controls Overlay */
        .overlay-container {
            position: absolute;
            z-index: 1000;
            pointer-events: none;
            top: 0; left: 0; right: 0; bottom: 0;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px;
        }

        .top-bar { display: flex; justify-content: space-between; align-items: flex-start; }
        
        .title-box {
            max-width: 350px;
        }
        .title-text { font-size: 24px; font-weight: 700; margin: 0 0 5px 0; letter-spacing: -0.5px; }
        .subtitle-text { font-size: 14px; color: #aaa; margin: 0; }

        /* Stats Box */
        .stats-box {
            max-width: 200px;
            text-align: right;
        }
        .stat-number { font-size: 32px; font-weight: 700; color: #00e676; margin: 0; }
        .stat-label { font-size: 12px; color: #aaa; text-transform: uppercase; letter-spacing: 1px; }

        /* Timeline Control */
        .timeline-container {
            width: 100%; 
            max-width: 600px;
            margin: 0 auto 20px auto;
            text-align: center;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .timeline-controls {
            flex-grow: 1;
        }
        
        .play-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .play-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }
        
        .slider-label {
            font-size: 14px;
            color: #ccc;
            margin-bottom: 10px;
            display: block;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .year-display {
            font-size: 42px;
            font-weight: 800;
            color: #fff;
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
            margin: 5px 0 15px 0;
            display: block;
        }

        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 24px;
            width: 24px;
            border-radius: 50%;
            background: #ffffff;
            cursor: pointer;
            margin-top: -10px;
            box-shadow: 0 0 10px rgba(255,255,255,0.5);
        }
        
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #444;
            border-radius: 2px;
        }

        /* Legend */
        .legend-box {
            position: absolute;
            bottom: 30px;
            right: 30px;
            width: 220px;
            pointer-events: auto;
        }
        .legend-item { display: flex; align-items: center; margin-bottom: 8px; font-size: 13px; }
        .dot { width: 10px; height: 10px; border-radius: 50%; margin-right: 10px; }

        /* Popup Styling */
        .leaflet-popup-content-wrapper {
            background-color: #1e1e1e;
            color: #fff;
            border: 1px solid #444;
            border-radius: 8px;
        }
        .leaflet-popup-tip { background-color: #1e1e1e; }
        .popup-header { font-size: 16px; font-weight: bold; margin-bottom: 5px; border-bottom: 1px solid #444; padding-bottom: 5px; }
        .popup-meta { font-size: 12px; color: #aaa; margin-bottom: 5px; }
        .popup-tag { 
            display: inline-block; padding: 2px 6px; border-radius: 4px; 
            font-size: 10px; font-weight: bold; text-transform: uppercase; margin-bottom: 5px;
        }
        .popup-service-area {
            background: rgba(0, 230, 118, 0.15);
            border: 1px solid rgba(0, 230, 118, 0.3);
            border-radius: 4px;
            padding: 4px 8px;
            margin-top: 8px;
            font-size: 12px;
        }
        .popup-service-area strong { color: #00e676; }

    </style>
</head>
<body>

    <div id="map"></div>

    <div class="overlay-container">
        <div class="top-bar">
            <div class="glass-panel title-box">
                <h1 class="title-text">Waymo Deployment</h1>
                <p class="subtitle-text">Interactive Timeline of Operations</p>
            </div>
            <div class="glass-panel stats-box">
                <p class="stat-number" id="cityCount">5</p>
                <p class="stat-label">Cities with Public Service</p>
            </div>
        </div>

        <div class="glass-panel timeline-container">
            <button id="playBtn" class="play-btn">
                <svg width="14" height="18" viewBox="0 0 14 18" fill="none" xmlns="http://www.w3.org/2000/svg" id="playIcon">
                    <path d="M1 1L13 9L1 17V1Z" stroke="white" stroke-width="2" stroke-linejoin="round"/>
                </svg>
                <svg width="14" height="18" viewBox="0 0 14 18" fill="none" xmlns="http://www.w3.org/2000/svg" id="pauseIcon" style="display:none;">
                    <path d="M1 1H5V17H1V1Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M9 1H13V17H9V1Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
            <div class="timeline-controls">
                <span class="slider-label">Commercial Service Timeline</span>
                <span id="yearDisplay" class="year-display">2025</span>
                <input type="range" id="yearSlider" min="2020" max="2028" value="2025" step="1">
                <div style="display: flex; justify-content: space-between; color: #666; font-size: 12px; margin-top: 5px;">
                    <span>2020</span>
                    <span>2028+</span>
                </div>
            </div>
        </div>
    </div>

    <div class="glass-panel legend-box">
        <div style="font-weight: 600; margin-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 5px;">
            Status Legend
        </div>
        <div class="legend-item"><span class="dot" style="background:#00e676; box-shadow: 0 0 5px #00e676;"></span>Live / Public Service</div>
        <div class="legend-item"><span class="dot" style="background:#ffab00;"></span>Testing / Employee Only</div>
        <div class="legend-item"><span class="dot" style="background:#2979ff;"></span>Mapping / Data Collection</div>
        <div class="legend-item"><span class="dot" style="background:#aaa; opacity: 0.5;"></span>Planned (Translucent)</div>
        <div style="margin-top: 10px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.1); font-size: 11px; color: #888;">
            <em>Dot size = service area coverage</em>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script>
        // Data with year-by-year service area information
        const waymoData = [
            // === LIVE PUBLIC SERVICE ===
            { 
                city: "Phoenix", state: "AZ", country: "USA",
                status: "Live - Fully Autonomous", 
                operationsStarted: 2016, publicYear: 2020, 
                lat: 33.4482948, lng: -112.0725488, 
                baseNotes: "First fully autonomous public ride-hail service.",
                notesByYear: {
                    2024: "Includes Sky Harbor Airport.",
                    2025: "Includes Sky Harbor Airport."
                },
                serviceAreaByYear: {
                    2020: "100 sq mi",
                    2021: "100 sq mi",
                    2022: "100 sq mi",
                    2023: "225 sq mi",
                    2024: "315 sq mi",
                    2025: "315 sq mi"
                }
            },
            { 
                city: "San Francisco Bay Area", state: "CA", country: "USA",
                status: "Live - Fully Autonomous", 
                operationsStarted: 2009, publicYear: 2022, 
                lat: 37.7749295, lng: -122.4194155, 
                baseNotes: "Includes Daly City/Colma.",
                serviceAreaByYear: {
                    2022: "~50 sq mi",
                    2023: "~50 sq mi",
                    2024: "55 sq mi",
                    2025: "260 sq mi"
                }
            },
            { 
                city: "Los Angeles", state: "CA", country: "USA",
                status: "Live - Fully Autonomous", 
                operationsStarted: 2019, publicYear: 2024, 
                lat: 34.0549076, lng: -118.242643, 
                baseNotes: "Serving the greater LA area.",
                notesByYear: {
                    2025: "Approved for freeways."
                },
                serviceAreaByYear: {
                    2023: "63 sq mi",
                    2024: "75 sq mi",
                    2025: "120 sq mi"
                }
            },
            { 
                city: "Austin", state: "TX", country: "USA",
                status: "Live - Partnership", 
                operationsStarted: 2023, publicYear: 2025, 
                lat: 30.267153, lng: -97.7430608, 
                baseNotes: "Available via Uber partnership.",
                serviceAreaByYear: {
                    2025: "90 sq mi"
                }
            },
            { 
                city: "Atlanta", state: "GA", country: "USA",
                status: "Live - Partnership", 
                operationsStarted: 2024, publicYear: 2025, 
                lat: 33.7501275, lng: -84.3885209, 
                baseNotes: "Available via Uber partnership.",
                serviceAreaByYear: {
                    2025: "65 sq mi"
                }
            },

            // === TESTING / EMPLOYEE OPERATIONS - 2026 PLANNED ===
            { 
                city: "Miami", state: "FL", country: "USA",
                status: "Testing - Fully Autonomous", 
                operationsStarted: 2025, publicYear: 2026, 
                lat: 25.7616798, lng: -80.1917902, 
                baseNotes: "Driverless testing started Nov 2025."
            },
            { 
                city: "Dallas", state: "TX", country: "USA",
                status: "Testing - Employee Only", 
                operationsStarted: 2025, publicYear: 2026, 
                lat: 32.7766642, lng: -96.7969879, 
                baseNotes: "Employee operations starting late 2025."
            },
            { 
                city: "Houston", state: "TX", country: "USA",
                status: "Testing - Employee Only", 
                operationsStarted: 2025, publicYear: 2026, 
                lat: 29.7600771, lng: -95.3701108, 
                baseNotes: "Employee operations starting late 2025."
            },
            { 
                city: "San Antonio", state: "TX", country: "USA",
                status: "Testing - Employee Only", 
                operationsStarted: 2025, publicYear: 2026, 
                lat: 29.4251905, lng: -98.4945922, 
                baseNotes: "Employee operations starting late 2025."
            },
            { 
                city: "Orlando", state: "FL", country: "USA",
                status: "Testing - Employee Only", 
                operationsStarted: 2025, publicYear: 2026, 
                lat: 28.5383832, lng: -81.3789269, 
                baseNotes: "Employee operations starting late 2025."
            },
            { 
                city: "Las Vegas", state: "NV", country: "USA",
                status: "Planned Expansion", 
                operationsStarted: 2025, publicYear: 2026, 
                lat: 36.171563, lng: -115.1391009, 
                baseNotes: "Targeting Summer 2026 launch."
            },
            { 
                city: "San Diego", state: "CA", country: "USA",
                status: "Planned Expansion", 
                operationsStarted: 2025, publicYear: 2026, 
                lat: 32.715738, lng: -117.1610838, 
                baseNotes: "Permits pending; announced late 2025."
            },
            { 
                city: "Nashville", state: "TN", country: "USA",
                status: "Planned Expansion", 
                operationsStarted: 2025, publicYear: 2026, 
                lat: 36.1626638, lng: -86.7816016, 
                baseNotes: "Included in future roadmap."
            },
            { 
                city: "Detroit", state: "MI", country: "USA",
                status: "Testing - Winter/Snow", 
                operationsStarted: 2016, publicYear: 2026, 
                lat: 42.3297182, lng: -83.0424533, 
                baseNotes: "Winter testing hub; driverless testing started 2025."
            },
            { 
                city: "Washington", state: "DC", country: "USA",
                status: "Testing - Delayed", 
                operationsStarted: 2025, publicYear: 2026, 
                lat: 38.9071923, lng: -77.0368707, 
                baseNotes: "Launch delayed due to regulatory issues."
            },
            { 
                city: "London", state: "", country: "UK",
                status: "Planned International", 
                operationsStarted: 2025, publicYear: 2026, 
                lat: 51.5072178, lng: -0.1275862, 
                baseNotes: "First international commercial launch target."
            },

            // === TESTING / MAPPING - TBD ===
            { 
                city: "Denver", state: "CO", country: "USA",
                status: "Testing - Safety Driver", 
                operationsStarted: 2025, publicYear: 2027, 
                lat: 39.7392358, lng: -104.990251, 
                baseNotes: "Testing with safety drivers started 2025."
            },
            { 
                city: "Seattle", state: "WA", country: "USA",
                status: "Testing - Mapping", 
                operationsStarted: 2025, publicYear: 2027, 
                lat: 47.6061389, lng: -122.3328481, 
                baseNotes: "Rain/Mapping data collection."
            },
            { 
                city: "New York City", state: "NY", country: "USA",
                status: "Testing - Safety Driver", 
                operationsStarted: 2023, publicYear: 2027, 
                lat: 40.7127753, lng: -74.0059728, 
                baseNotes: "Manhattan/Brooklyn pilot with safety drivers."
            },
            { 
                city: "Baltimore", state: "MD", country: "USA",
                status: "Testing - Mapping", 
                operationsStarted: 2025, publicYear: 2027, 
                lat: 39.2904, lng: -76.6122, 
                baseNotes: "Manual test fleet; phased rollout planned."
            },
            { 
                city: "Pittsburgh", state: "PA", country: "USA",
                status: "Testing - Mapping", 
                operationsStarted: 2025, publicYear: 2027, 
                lat: 40.4406, lng: -79.9959, 
                baseNotes: "Mapping and manually driven test vehicles."
            },
            { 
                city: "St. Louis", state: "MO", country: "USA",
                status: "Testing - Mapping", 
                operationsStarted: 2025, publicYear: 2027, 
                lat: 38.627, lng: -90.1994, 
                baseNotes: "Data collection with human drivers."
            },

            // === TESTING ONLY - FAR FUTURE ===
            { 
                city: "Buffalo", state: "NY", country: "USA",
                status: "Testing - Winter/Snow", 
                operationsStarted: 2024, publicYear: 2028, 
                lat: 42.8864468, lng: -78.8783689, 
                baseNotes: "Winter weather capability testing."
            },
            { 
                city: "Boston", state: "MA", country: "USA",
                status: "Testing - Mapping", 
                operationsStarted: 2025, publicYear: 2028, 
                lat: 42.3601, lng: -71.0589, 
                baseNotes: "Mapping and data collection."
            },
            { 
                city: "New Orleans", state: "LA", country: "USA",
                status: "Testing - Mapping", 
                operationsStarted: 2025, publicYear: 2028, 
                lat: 29.9511, lng: -90.0715, 
                baseNotes: "Mapping and data collection."
            },
            { 
                city: "Philadelphia", state: "PA", country: "USA",
                status: "Testing - Mapping", 
                operationsStarted: 2025, publicYear: 2028, 
                lat: 39.9526, lng: -75.1652, 
                baseNotes: "Testing with safety drivers started 2025."
            },
            { 
                city: "Minneapolis", state: "MN", country: "USA",
                status: "Testing - Mapping", 
                operationsStarted: 2025, publicYear: 2028, 
                lat: 44.9778, lng: -93.265, 
                baseNotes: "Cold-weather testing focus."
            },
            { 
                city: "Tampa", state: "FL", country: "USA",
                status: "Testing - Mapping", 
                operationsStarted: 2025, publicYear: 2028, 
                lat: 27.9506, lng: -82.4572, 
                baseNotes: "Manual-driving test fleet."
            },
            { 
                city: "Tokyo", state: "", country: "Japan",
                status: "Testing - Mapping", 
                operationsStarted: 2025, publicYear: 2028, 
                lat: 35.6764225, lng: 139.650027, 
                baseNotes: "Testing in Minato and Shibuya wards."
            }
        ];

        // Map Initialization
        const map = L.map('map', {
            zoomControl: false,
            attributionControl: false
        }).setView([36.0, -96], 4);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 20
        }).addTo(map);
        
        L.control.attribution({position: 'bottomleft'}).addTo(map);

        let markersLayer = L.layerGroup().addTo(map);

        // Helper: Get Color based on Status
        function getColor(status) {
            if (status.includes('Live')) return '#00e676';
            if (status.includes('Testing') && (status.includes('Employee') || status.includes('Autonomous') || status.includes('Safety Driver') || status.includes('Winter'))) return '#ffab00';
            if (status.includes('Testing') || status.includes('Mapping')) return '#2979ff';
            return '#2979ff'; // Planned
        }

        // Helper: Get service area for a specific year
        function getServiceAreaForYear(loc, year) {
            if (!loc.serviceAreaByYear) return null;
            
            // Find the most recent service area data at or before this year
            let relevantYear = null;
            for (let y = year; y >= 2020; y--) {
                if (loc.serviceAreaByYear[y]) {
                    relevantYear = y;
                    break;
                }
            }
            
            return relevantYear ? loc.serviceAreaByYear[relevantYear] : null;
        }

        // Update Map function
        function updateMap(year) {
            markersLayer.clearLayers();
            let publicCityCount = 0;

            waymoData.forEach(loc => {
                // Determine visibility: show if operations have started or public service year reached
                const showOnMap = (loc.operationsStarted <= year) || (loc.publicYear <= year);
                
                if (!showOnMap) return;

                const isPublic = loc.publicYear <= year && loc.status.includes('Live');
                const isFuture = loc.publicYear > year;
                const isNew = loc.publicYear === year && !isFuture;
                
                if (isPublic) publicCityCount++;

                const color = getColor(loc.status);
                
                // Determine current status based on timeline
                let displayStatus = loc.status;
                if (isFuture && loc.status.includes('Live')) {
                    // Before public launch, show as testing
                    if (loc.status.includes('Partnership')) {
                        displayStatus = 'Pre-Launch Testing';
                    } else {
                        displayStatus = 'Testing - Pre-Launch';
                    }
                }

                // Get service area for this year
                const serviceArea = getServiceAreaForYear(loc, year);

                // Calculate radius based on service area (if available and public)
                let radius = 6; // Default for testing/mapping locations
                if (serviceArea && loc.publicYear <= year) {
                    // Extract numeric value from service area string (e.g., "315 sq mi" -> 315)
                    const areaValue = parseInt(serviceArea.replace(/[^0-9]/g, ''));
                    // Scale: sqrt for area-to-radius, then normalize (min 8, max 28)
                    radius = Math.max(8, Math.min(28, 4 + Math.sqrt(areaValue) * 1.4));
                }
                if (isNew) radius = Math.max(radius, 12); // Ensure new launches are visible

                const marker = L.circleMarker([loc.lat, loc.lng], {
                    radius: radius,
                    fillColor: color,
                    color: "#fff",
                    weight: isFuture ? 0 : 1,
                    opacity: isFuture ? 0 : 1,
                    fillOpacity: isFuture ? 0.35 : 0.85
                });

                // Build notes with year-appropriate service area and dynamic notes
                
                // Get year-specific notes if available
                let displayNotes = loc.baseNotes;
                if (loc.notesByYear) {
                    // Find the most recent note at or before this year
                    let relevantNoteYear = null;
                    for (let y = year; y >= 2020; y--) {
                        if (loc.notesByYear[y]) {
                            relevantNoteYear = y;
                            break;
                        }
                    }
                    if (relevantNoteYear) {
                        displayNotes += " " + loc.notesByYear[relevantNoteYear];
                    }
                }
                
                let notesHtml = `<div style="font-size:13px; line-height: 1.4;">${displayNotes}</div>`;
                
                if (serviceArea && loc.publicYear <= year) {
                    notesHtml += `<div class="popup-service-area"><strong>Service Area:</strong> ${serviceArea}</div>`;
                }

                const locationLabel = loc.state ? `${loc.city}, ${loc.state}` : `${loc.city}, ${loc.country}`;
                
                const popupContent = `
                    <div class="popup-header">${locationLabel}</div>
                    <div class="popup-tag" style="border: 1px solid ${color}; color: ${color}; background: rgba(255,255,255,0.05)">${displayStatus}</div>
                    <div class="popup-meta">
                        Operations: ${loc.operationsStarted} | 
                        Public: ${loc.publicYear > 2025 ? loc.publicYear + ' (Planned)' : loc.publicYear}
                    </div>
                    ${notesHtml}
                `;

                marker.bindPopup(popupContent);
                marker.on('mouseover', function (e) { this.openPopup(); });
                marker.on('mouseout', function (e) { this.closePopup(); });

                markersLayer.addLayer(marker);
            });

            // Update city count
            document.getElementById('cityCount').innerText = publicCityCount;
        }

        // Slider & Play Logic
        const slider = document.getElementById('yearSlider');
        const display = document.getElementById('yearDisplay');
        const playBtn = document.getElementById('playBtn');
        const playIcon = document.getElementById('playIcon');
        const pauseIcon = document.getElementById('pauseIcon');
        
        let isPlaying = false;
        let intervalId = null;

        function togglePlay() {
            isPlaying = !isPlaying;
            if (isPlaying) {
                playIcon.style.display = 'none';
                pauseIcon.style.display = 'block';
                
                if (parseInt(slider.value) >= parseInt(slider.max)) {
                    slider.value = slider.min;
                    updateDisplayAndMap(slider.min);
                }
                
                intervalId = setInterval(() => {
                    let currentVal = parseInt(slider.value);
                    if (currentVal < parseInt(slider.max)) {
                        currentVal++;
                        slider.value = currentVal;
                        updateDisplayAndMap(currentVal);
                    } else {
                        togglePlay();
                    }
                }, 1000);
            } else {
                playIcon.style.display = 'block';
                pauseIcon.style.display = 'none';
                clearInterval(intervalId);
            }
        }

        function updateDisplayAndMap(val) {
            display.innerText = val;
            updateMap(parseInt(val));
        }

        slider.addEventListener('input', (e) => {
            updateDisplayAndMap(e.target.value);
        });

        playBtn.addEventListener('click', togglePlay);

        // Initial Load
        updateDisplayAndMap(2025);

    </script>
</body>
</html>
